<!DOCTYPE html>
<html>
    <head>
        <title>Shape experiment</title>
        <script src="jspsych-6.0.5/jspsych.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-html-slider-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-video.js"></script>
        <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body></body>
    <script>

      /* create timeline */
      var timeline = [];

      // assign a unique number to the participant
      var enter_experiment_number = {
        type: "survey-text",
        questions: [{prompt: "Enter participant number:"}],
        data: {test_part: 'experiment_number'}
      }
      timeline.push(enter_experiment_number);

      // project title
      var welcome = {
        type: "html-keyboard-response",
        stimulus: "<p>Project title: <p>" +
          "<p>Welcome to the experiment. Press any key to begin.<p>"
      };
      timeline.push(welcome);

      // give instructions to the experiment
      var instructions = {
        type: "html-keyboard-response",
        stimulus: "<p>In this experiment... (to be finished).</p>"+
          "<p>Press any key to begin.</p>",
      };
      timeline.push(instructions);

      // creates fixation plus sign
      var fixation = {
        type: 'html-keyboard-response',
        stimulus: '<p>+</p>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 2000,
        data: {test_part: 'fixation'}
      }

      // creates screen right before beginning practice
      var practice_proceed = {
        type: "html-keyboard-response",
        stimulus: "<p>This will be a practice round.</p>"+
          "<p>Press any key to continue.</p>"
      }

      var practice_videos = [
        "<iframe src='videos/bouncing_obs.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/searching_obs.mp4' width='640' height='360'></iframe>"
      ];

      var practice_time_list = [
        13000,
        10000
      ];

      var obs = [
        "<iframe src='videos/bouncing_obs.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/bumping_obs.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/ignoring_obs.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/meeting_obs.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/rounding_obs.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/searching_obs.mp4' width='640' height='360'></iframe>"
      ];

      // 1000 added to video length
      var obs_time_list = [
        13000,
        4000,
        7000,
        9000,
        13000,
        10000
      ];


      var social_feedback_videos = [
        "<iframe src='videos/bouncing_social.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/bumping_social.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/ignoring_social.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/meeting_social.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/rounding_social.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/searching_social.mp4' width='640' height='360'></iframe>",
      ];

      var physical_feedback_videos = [
        "<iframe src='videos/bouncing_physical.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/bumping_physical.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/ignoring_physical.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/meeting_physical.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/rounding_physical.mp4' width='640' height='360'></iframe>",
        "<iframe src='videos/searching_physical.mp4' width='640' height='360'></iframe>",
      ];

      var sf_time_list = [
        4000,
        3000,
        4000,
        3000,
        6000,
        3000
      ];

      var pf_time_list = [
        6000,
        3000,
        2000,
        13000,
        10000,
        16000
      ];


      // creates random number, either 0 or 1, used for practice
      var randomization1 = Math.floor((Math.random() * 2));

      // array of options/answers to multiple choice question
      var question_options = ['up', 'down', 'left', 'right','other'];

      // creates multiple choice question
      var question = {
        type: "survey-multi-choice",
        questions: [{prompt: "Make a prediction about where the green square will go next: ", options: question_options, required: true}],
        data: {test_part: 'question'}
      }

      var practice_other = {
        type: "survey-text",
        questions: function() {
          var multiple_choice_response = jsPsych.data.get().filter({test_part: 'question'}).select('responses').values[0];
          if (multiple_choice_response == '{"Q0":"other"}') {
            return [{prompt: "Other:", rows:3}];
          }
          return [{prompt: "Press 'continue' to see the actual result", rows:1, columns:1}];
        },
        data: {test_part: 'practice_other'}
      }



      // rate level of surprise
      var slider = {
        type: "html-slider-response",
        stimulus: "How surprised were you?"
      }

      // free response question to explain level of surprise
      var explanation = {
        type: "survey-text",
        questions: [{prompt: "Explain your answer."}]
      }

      // creates video object for the practice round
      var selected_video = {
        type: "html-keyboard-response",
        stimulus: practice_videos[randomization1],
        choices: jsPsych.NO_KEYS,
        trial_duration: practice_time_list[randomization1]
      }

      // creates nested timeline for practice round
      var practice_round = {
        timeline: [practice_proceed, fixation, selected_video, question, practice_other]
      }
      timeline.push(practice_round);

      // screen right before test begins
      var test_intro = {
        type: "html-keyboard-response",
        stimulus: "<p>The practice round has ended. The task will now begin.<p>"+
          "<p>Press any key to continue</p>"
      }
      timeline.push(test_intro);

// condition ? return if true, return if false
      var feedback_videos = randomization1 == 0 ? social_feedback_videos: physical_feedback_videos;

      var test_procedure = create_trials(
        obs,
        feedback_videos,
        randomization1,
        question,
        slider,
        explanation,
        obs_time_list,
        fixation,
        sf_time_list,
        pf_time_list
      );

      // puts nested timeline into big timeline
      var test_trials = {
        timeline: test_procedure
      }
      timeline.push(test_trials);

      // end screen
      var task_finish = {
        type: "html-keyboard-response",
        stimulus: "<p>Press any key to continue</p>"
      }
      timeline.push(task_finish);

      jsPsych.init({
        timeline: timeline,
        on_finish: function(data){
          jsPsych.data.displayData();
        }
      });

      // method creates nested timeline for the test part
      function create_trials(
        obs,
        feedback_videos,
        randomization1,
        question,
        slider,
        explanation,
        obs_time_list,
        fixation,
        sf_time_list,
        pf_time_list) {

        // define nested timeline
        var logistics_timeline = [];
        var i = 0;
        for (i = 0; i < obs.length; i++) {
          // put observed video in timeline
          var video_object = {
            type: "html-keyboard-response",
            stimulus: obs[i],
            choices: jsPsych.NO_KEYS,
            trial_duration: obs_time_list[i]
          }

          // put fixation, social video, and multiple choice question in timeline
          logistics_timeline.push(fixation);

          logistics_timeline.push(video_object);

          logistics_timeline.push(question);

          var other = {
            type: "survey-text",
            questions: function() {
              var length = jsPsych.data.get().filter({test_part: 'question'}).select('responses').values.length;
              var multiple_choice_response = jsPsych.data.get().filter({test_part: 'question'}).select('responses').values[length-1];
              if (multiple_choice_response == '{"Q0":"other"}') {
                return [{prompt: "Other:", rows:3}];
              }
              return [{prompt: "Press 'continue' to see the actual result", rows:1, columns:1}];
            },
            data: {test_part: 'other'}
          }
          logistics_timeline.push(other);

          // if the random number is 0 -- the videos are all social
          if (randomization1 == 0) {

            // put feedback video in timeline
            var feedback_object = {
              type: "html-keyboard-response",
              stimulus: social_feedback_videos[i],
              choices: jsPsych.NO_KEYS,
              trial_duration: sf_time_list[i]
            }
            logistics_timeline.push(feedback_object);
          }

          // same thing except this time the random number is 1 and the videos are all physical
          else {

            var feedback_object = {
              type: "html-keyboard-response",
              stimulus: physical_feedback_videos[i],
              choices: jsPsych.NO_KEYS,
              trial_duration: pf_time_list[i]
            }
            logistics_timeline.push(feedback_object);
          }

          // put slider question in timeline
          logistics_timeline.push(slider);

          // put explanation in timeline
          logistics_timeline.push(explanation);
        }
        return logistics_timeline;
      }

    </script>
</html>
