<!DOCTYPE html>
<html>
    <head>
        <title>Shape experiment</title>
        <script src="jspsych-6.0.5/jspsych.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-html-slider-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-video.js"></script>
        <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body></body>
    <script>

      // create timeline
      let timeline = [];

      // assign a unique number to the participant
      let enter_participant_id = {

        // jsPsych specific: must enter the type of object
        type: "survey-text",

        // for "survey-text", there must be an array of questions in this format
        questions: [{prompt: "Enter participant ID number (6 digits):"}],

        // create an additional property with key "test_part" for easy access later
        data: {test_part: 'participant_id'}
      }
      // pushes the object to the timeline
      timeline.push(enter_participant_id);


      // welcome user
      let welcome = {

        // html-keyboard-response allows the user to continue via key press
        // by default user may press any key
        type: "html-keyboard-response",

        // stimulus is the text displayed on the screen, prompts user
        stimulus: "<p>Project title: (social prediction) <p>" +
          "<p>Welcome to the experiment. Press any key to begin.<p>"
      };
      timeline.push(welcome);

      // give instructions to the experiment
      let instructions = {
        type: "html-keyboard-response",
        stimulus: "<p>In this experiment... (to be finished).</p>"+
          "<p>Press any key to continue.</p>",
      };
      timeline.push(instructions);

      // create fixation plus sign
      let fixation = {
        type: 'html-keyboard-response',
        stimulus: '<b>+</b>',

        // the user may not press any keys to continue
    //    choices: jsPsych.NO_KEYS,

        // instead, the user must wait 2 seconds
        trial_duration: 2000,
        data: {test_part: 'fixation'}
      }

      // create screen right before beginning practice
      let practice_proceed = {
        type: "html-keyboard-response",
        stimulus: "<p>This will be a practice round.</p>"+
          "<p>Press any key to continue.</p>"
      }

      // list of practice video links
      let practice_videos = [
        "<iframe src='videos/practice_social.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/practice_pattern.mp4' width='600' height='360'></iframe>"
      ];

      // list of practice video times (in milliseconds)
      // 1000 added to video length to compensate for video loading speed
      let practice_time_list = [
        7000,
        8000
      ];

      // create list of numbers 0 to n
      // this list will be randomized later
      // randomized array to be used for shuffling video order
      let unshuffled_array = [
        0,
        1,
        2,
        3,
        4,
        5
      ];

      // call shuffle() function, value assigned to shuffled_array
      let shuffled_array = shuffle(unshuffled_array);

      // unshuffled list of test videos
      let unshuffled_obs = [
        "<iframe src='videos/bouncing_obs.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/bumping_obs.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/ignoring_obs.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/meeting_obs.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/rounding_obs.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/searching_obs.mp4' width='600' height='360'></iframe>"
      ];

      // unshuffled list of test video times
      // 1000 added to video length to compensate for video loading speed
      let unshuffled_obs_time_list = [
        13000,
        4000,
        7000,
        9000,
        13000,
        10000
      ];

      // unshuffled list of social feedback video times
      let unshuffled_social_feedback_videos = [
        "<iframe src='videos/bouncing_social.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/bumping_social.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/ignoring_social.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/meeting_social.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/rounding_social.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/searching_social.mp4' width='600' height='360'></iframe>"
      ];

      // unshuffled list of pattern feedback video times
      let unshuffled_pattern_feedback_videos = [
        "<iframe src='videos/bouncing_pattern.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/bumping_pattern.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/ignoring_pattern.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/meeting_pattern.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/rounding_pattern.mp4' width='600' height='360'></iframe>",
        "<iframe src='videos/searching_pattern.mp4' width='600' height='360'></iframe>"
      ];

      // unshuffled list of social feedback video times
      // 1000 added to video length to compensate for video loading speed
      let unshuffled_sf_time_list = [
        3500,
        3000,
        4000,
        3000,
        6000,
        3000
      ];

      // unshuffled list of pattern feedback video times
      // 1000 added to video length to compensate for video loading speed
      let unshuffled_pf_time_list = [
        6000,
        3000,
        2000,
        13000,
        10000,
        6000
      ];

      // calls match_with_array function
      // shuffles all of the test arrays according to the shuffled array of integers
      // they can't each be shuffled differently because the videos still need to correspond to one another
      let obs = match_with_array(shuffled_array, unshuffled_obs);
      let obs_time_list = match_with_array(shuffled_array, unshuffled_obs_time_list);
      let social_feedback_videos = match_with_array(shuffled_array, unshuffled_social_feedback_videos);
      let pattern_feedback_videos = match_with_array(shuffled_array, unshuffled_pattern_feedback_videos);
      let sf_time_list = match_with_array(shuffled_array, unshuffled_sf_time_list);
      let pf_time_list = match_with_array(shuffled_array, unshuffled_pf_time_list);

      // create random number, either 0 or 1, used for practice
      let randomization1 = Math.floor((Math.random() * 2));

      // calls id() function and sets it to id
  //    let id = id();

      // array of options/answers to multiple choice question
      let question_options = ['up', 'down', 'left', 'right','other'];

      // create object: multiple choice practice question
      let practice_question = {
        type: "survey-multi-choice",
        questions: [{prompt: "Make a prediction about where the <font color='red'>RED</font> triangle will go next: ", options: question_options, required: true}],
        data: {test_part: 'practice_question'}
      }

      // create object: multiple choice test question
      let question = {
        type: "survey-multi-choice",
        questions: [{prompt: "Make a prediction about where the <font color='MediumSeaGreen'>GREEN</font> square will go next: ", options: question_options, required: true}],
        data: {test_part: 'question'}
      }

      // create object
      // if other was picked, prompt user with type response
      // if a direction was picked, show 1 millisecond blank screen
      let practice_other = {

        // function returns timeline object type
        type: function() {

          // get the user's response to the practice question under the key called "responses"
          let multiple_choice_response = jsPsych.data.get().filter({test_part: 'practice_question'}).select('responses').values[0];

          // return test type according to value of the key
          if (multiple_choice_response == '{"Q0":"other"}') {
            return 'survey-text';
          }
          return 'html-keyboard-response';
        },

        // since stimulus is required if the test type is "html-keyboard-response", it will be a blank space
        // if the test type is "survey-test", this key will be IGNORED
        stimulus: ' ',

        // prompts user to provide written explanation if test type is "survey text"
        // if the test type is "html-keyboard-response", this key will be IGNORED
        questions: function hello1() {

          let multiple_choice_response = jsPsych.data.get().filter({test_part: 'practice_question'}).select('responses').values[0];
          if (multiple_choice_response == '{"Q0":"other"}') {
            return [{prompt: "Other:", rows:3}];
          }
        },
        data: {test_part: 'practice_other'},

        // makes the blank screen 1 millisecond long only if "html-keyboard-response"
        trial_duration: 1
      }

      // rate level of surprise
      let slider = {
        type: "html-slider-response",
        stimulus: "How surprised were you?",

        // labels the slider
        labels: ["not surprised", "very surprised"],
        slider_width: 800,
        data: {test_part: 'slider'}
      }

      // free response question to explain level of surprise
      let explanation = {
        type: "survey-text",
        questions: [{prompt: "Explain your answer."}],
        data: {test_part: 'explanation'}
      }

      // create video object for the practice round
      let selected_video = {
        type: "html-keyboard-response",

        // using the random number generated (0 or 1), select either the social or physical practice video
        stimulus: practice_videos[randomization1],
    //    choices: jsPsych.NO_KEYS,

        // using random number generated, select the corresponding time
        trial_duration: practice_time_list[randomization1]
      }

      // create nested timeline for practice round
      let practice_round = {
        timeline: [practice_proceed, fixation, selected_video, practice_question, practice_other]
      }
      timeline.push(practice_round);

      // screen right before test begins
      let test_intro = {
        type: "html-keyboard-response",
        stimulus: "<p>The practice round has ended. The task will now begin.<p>"+
          "<p>Press any key to continue</p>"
      }
      timeline.push(test_intro);

      // condition ? return social_feedback_videos if true, return pattern_feedback_videos if false
      let feedback_videos = randomization1 == 0 ? social_feedback_videos: pattern_feedback_videos;

      // call create_trials() function
      let test_procedure = create_trials(
        obs,
        feedback_videos,
        randomization1,
        question,
        slider,
        explanation,
        obs_time_list,
        fixation,
        sf_time_list,
        pf_time_list
      );

      // puts nested timeline into big timeline
      let test_trials = {
        timeline: test_procedure
      }
      timeline.push(test_trials);

      // end screen
      let task_finish = {
        type: "html-keyboard-response",
        stimulus: "<p>Press any key to continue</p>"
      }
      timeline.push(task_finish);


      jsPsych.init({
        timeline: timeline,
        on_finish: function(data){
          jsPsych.data.displayData();
          console.log("DATA FROM ALL TRIALS", experiment_data());

          let id_unparsed = jsPsych.data.get().filter({test_part: 'participant_id'}).select('responses').values[0];
          let id_parsed = JSON.parse(id_unparsed);
          let id = id_parsed["Q0"];
          console.log("id", id)
          send_data(id);
        }
      });
/*
      // create 6 digit id that each participant is assigned to and is then required to enter upon finishing the study
      function id() {
        let id = 0;

        // loop removes any "6 digit" numbers under 100,000
        while (id < 100000) {

          // generates random number between 0 and 999,999
          id = Math.floor((Math.random() * 1000000))
        }
        return id;
      }
*/
      // method create nested timeline for the test part
      function create_trials(
        obs,
        feedback_videos,
        randomization1,
        question,
        slider,
        explanation,
        obs_time_list,
        fixation,
        sf_time_list,
        pf_time_list) {

        // define nested timeline
        let logistics_timeline = [];
        let i = 0;
        for (i = 0; i < obs.length; i++) {
          // put observed video in timeline
          let video_object = {
            type: "html-keyboard-response",
            stimulus: obs[i],
    //        choices: jsPsych.NO_KEYS,
            trial_duration: obs_time_list[i],
            data: {test_part: 'video_url'}
          }

          // put fixation, social video, and multiple choice question in timeline
          logistics_timeline.push(fixation);

          logistics_timeline.push(video_object);

          logistics_timeline.push(question);

          let other = {
            type: function() {
              let length = jsPsych.data.get().filter({test_part: 'question'}).select('responses').values.length;
              let multiple_choice_response = jsPsych.data.get().filter({test_part: 'question'}).select('responses').values[length-1];
              if (multiple_choice_response == '{"Q0":"other"}') {
                return 'survey-text';
              }
              return 'html-keyboard-response';
            },
            stimulus: ' ',
            questions: function question() {
              let length = jsPsych.data.get().filter({test_part: 'question'}).select('responses').values.length;
              let multiple_choice_response = jsPsych.data.get().filter({test_part: 'question'}).select('responses').values[length-1];
              if (multiple_choice_response == '{"Q0":"other"}') {
                return [{prompt: "Other:", rows:3}];
              }
            },
            data: function testpart() {
              let length = jsPsych.data.get().filter({test_part: 'question'}).select('responses').values.length;
              let multiple_choice_response = jsPsych.data.get().filter({test_part: 'question'}).select('responses').values[length-1];
              if (multiple_choice_response == '{"Q0":"other"}') {
                return {test_part: 'other'};
              }
              return {test_part: 'other', responses: 'not an "other"'};
            },

            trial_duration: 1
          }
          logistics_timeline.push(other);

          // if the random number is 0 -- the videos are all social
          if (randomization1 == 0) {

            // put feedback video in timeline
            let feedback_object = {
              type: "html-keyboard-response",
              stimulus: social_feedback_videos[i],
      //        choices: jsPsych.NO_KEYS,
              trial_duration: sf_time_list[i],
              data: {test_part:'feedback_url'}
            }
            logistics_timeline.push(feedback_object);
          }

          // same thing except this time the random number is 1 and the videos are all pattern
          else {

            let feedback_object = {
              type: "html-keyboard-response",
              stimulus: pattern_feedback_videos[i],
      //        choices: jsPsych.NO_KEYS,
              trial_duration: pf_time_list[i],
              data: {test_part:'feedback_url'}
            }
            logistics_timeline.push(feedback_object);
          }

          // put slider question in timeline
          logistics_timeline.push(slider);

          // put explanation in timeline
          logistics_timeline.push(explanation);
        }
        return logistics_timeline;
      }

      // function that uses the data and makes a JSON object of a trial
      function experiment_data() {
        //things to get: {video url: , answer to question: , feedback video url: ,  slider value: , explanation: , }
        let trial_timeline = [];
        for (let i = 0; i < obs.length; i++) {
          let json = {
            "video_url":jsPsych.data.get().filter({test_part: 'video_url'}).select('stimulus').values[i],
            "answer_to_question":jsPsych.data.get().filter({test_part: 'question'}).select('responses').values[i],
            "other_explanation": jsPsych.data.get().filter({test_part: 'other'}).select('responses').values[i],
            "feedback_url":jsPsych.data.get().filter({test_part: 'feedback_url'}).select('stimulus').values[i],
            "slider_value":jsPsych.data.get().filter({test_part: 'slider'}).select('response').values[i],
            "slider_explanation":jsPsych.data.get().filter({test_part: 'explanation'}).select('responses').values[i]
          }
          trial_timeline.push(json);
        }
        return trial_timeline;
      }

      function shuffle(array) {
        let currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
        while (0 !== currentIndex) {

    // Pick a remaining element...
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;

    // And swap it with the current element.
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }
        return array;
      }

      function match_with_array (shuffled_array, substance_array) {
        let new_array = [];
        for (let i = 0; i < shuffled_array.length; i++) {
          let shuffled_value = shuffled_array[i];
          new_array.push(substance_array[shuffled_value]);
        }
        return new_array;
      }

      function send_data(id) {
        let xhr = new XMLHttpRequest();
        xhr.open("POST", "https://7k5k1tu2bl.execute-api.us-east-1.amazonaws.com/Production/SaveData", true);
        xhr.setRequestHeader('Content-Type', "application/x-www-form-urlencoded; charset=UTF-8");
        xhr.send(JSON.stringify({
          "data":JSON.stringify(experiment_data()),
          "participant_id":id
        }));
      }



    </script>
</html>
